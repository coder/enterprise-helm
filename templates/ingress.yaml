{{- if .Values.ingress.enable }}
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: coderd-ingress
  namespace: {{ .Release.Namespace | quote }}
  annotations: {{ toYaml .Values.ingress.annotations | nindent 4 }}
spec:
{{- include "coder.ingress.tls" . }}
  rules:
  - host: {{ .Values.ingress.host | quote }}
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: {{ include "coder.serviceName" . }}
            port:
              name: tcp-{{ include "coder.serviceName" . }}

    {{/* Regex docs on '*-suffix.example.com'. This is required as the original
       * input including the suffix is not a legal ingress host. We need to
       * remove the suffix, and keep the wildcard '*'.
       *
       *   - '\\*'     Starts with '*'
       *   - '[^.]*'   Suffix is 0 or more characters, '-suffix'
       *   - '('       Start domain capture group
       *   -   '\\.'     The domain should be separated with a '.' from the subdomain
       *   -   '.*'      Rest of the domain.
       *   - ')'       $1 is the ''.example.com'
       */}}
  - host: {{ regexReplaceAll "\\*[^.]*(\\..*)" .Values.coderd.devurlsHost "*${1}" | quote }}
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: {{ include "coder.serviceName" . }}
            port:
              name: tcp-{{ include "coder.serviceName" . }}
{{- end }}
